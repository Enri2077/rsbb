#!/usr/bin/env python
# -*- coding: utf-8 -*-

import sys
from benchmark_scripts import *
import benchmark_scripts
import rospy
import actionlib
from rsbb_benchmarking_messages.srv import *
from rockin_scoring.BenchmarkObject import *
#from inspect import *
from exceptions import Exception


scripts = {}
execute_request = None
terminate_benchmark_request = False

def import_benchmark_scripts():
	
	global scripts
	
	print "imported scripts:"
	
	for module_name in benchmark_scripts.__all__:
		module = globals()[module_name]
		
		try:
			
			benchmark_object = module.BenchmarkObject()
			benchmark_code = ""
			
			try:
				
				benchmark_code = benchmark_object.get_benchmark_code()
				
			except AttributeError:
				raise BenchmarkCodeNotImplementedError("method get_benchmark_code not implemented in BenchmarkObject")
				#TODO publish benchmark_script_server SystemStatus.ERROR
				
			except TypeError:
				raise BenchmarkCodeNotImplementedError("Wrong number of attributes in get_benchmark_code method")
				#TODO publish benchmark_script_server SystemStatus.ERROR
				
			
			if type(benchmark_code) != type(""):
				print "type(benchmark_code) != type(\"\")"
				raise BenchmarkCodeNotImplementedError("Method get_benchmark_code in BenchmarkObject should return a string")
						
			scripts[benchmark_code] = benchmark_object
			
			print benchmark_code
			
			
		except BenchmarkCodeNotImplementedError as e:
			print e.parameter
			rospy.logerr("Error from script [%s]: %s", module_name, e.parameter)
			
		except ExecuteMethodNotImplementedError:
			rospy.logerr("NotImplementedError Exception")




class BenchmarkServer(object):
	
	def __init__(self, init_benchmark_service_name, terminate_benchmark_service_name):
		self._init_benchmark_service_name = init_benchmark_service_name
		self._init_benchmark_request_service_server = rospy.Service(self._init_benchmark_service_name, BenchmarkRequest, self.execute_benchmark_callback)

		self._terminate_benchmark_service_name = terminate_benchmark_service_name
		self._terminate_benchmark_request_service_server = rospy.Service(self._terminate_benchmark_service_name, TerminateBenchmarkScript, self.terminate_benchmark_callback)
	
	
	def execute_benchmark_callback(self, request):
		rospy.loginfo('execute_benchmark_callback: benchmark_code %s \t team: %s \t robot: %s\t run: %i' % (request.benchmark_code, request.team, request.robot, request.run))
		
		global execute_request
		global execute_request_info
		execute_request = request.benchmark_code
		execute_request_info = request
		
		return BenchmarkRequestResponse(True)
		#TODO return false if request.benchmark_code not in scripts
	
	
	
	def terminate_benchmark_callback(self, request):
		rospy.loginfo('terminate_benchmark_callback')
		
		global execute_request
		global terminate_benchmark_request
		
		if execute_request != None: print "can_terminate_benchmark: ", scripts[execute_request].can_terminate_benchmark()
		
		if execute_request == None or terminate_benchmark_request == True or not scripts[execute_request].can_terminate_benchmark():
			return TerminateBenchmarkScriptResponse(False)
		
		terminate_benchmark_request = True
		
		scripts[execute_request].terminate_benchmark()
		
		return TerminateBenchmarkScriptResponse(True)
		
		#TODO return false if benchmark is not in state BmBoxState.END



def init_server():
	global execute_request
	
	rospy.init_node('rsbb_benchmark_server')
	rate = rospy.Rate(1) # 10hz
	
	import_benchmark_scripts()
	
	server = BenchmarkServer("init_benchmark", "terminate_benchmark_script")
	
	print "\nready to execute imported benchmark scripts"
	
	while not rospy.is_shutdown():
		
		if execute_request:
			try:
				
				print "start execute()"
				scripts[execute_request].setup(execute_request_info.team, execute_request_info.run)
				scripts[execute_request].execute()
				
			except ExecuteMethodNotImplementedError as e:
				rospy.logerr("Error for execute request [%s]: method execute(self) not implemented in BenchmarkObject", execute_request)
				rospy.logerr(e)
				#TODO publish benchmark_script_server SystemStatus.ERROR
				
			except rospy.ROSInterruptException as e:
				rospy.loginfo("Shutdown signal received")
				rospy.loginfo(e)
#				pass
				
			except Exception as e:
				rospy.logerr("Exception raised in benchmark script [%s]. Benchmark script terminated", execute_request)
				rospy.signal_shutdown("Exception raised in benchmark script")
				raise
#				rospy.logerr(e)
				#TODO publish benchmark_script_server SystemStatus.ERROR
			
			execute_request = None
			print "finished execute()"
			
			rospy.spin()
			
		
		rate.sleep()


if __name__ == '__main__':
	try:
		init_server()
	except rospy.ROSInterruptException:
		pass
		









